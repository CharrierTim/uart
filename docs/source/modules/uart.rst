UART
====

.. toctree::
    :maxdepth: 1
    :caption: Sub-modules:

    uart_rx
    uart_tx

Description
-----------

Generics
--------

.. list-table::
    :widths: 25 10 15 60
    :header-rows: 1

    - - Generic Name
      - Type
      - Default Value
      - Description
    - - ``G_CLK_FREQ_HZ``
      - positive
      - 0d50\_000\_000
      - Clock frequency in Hz of ``CLK``
    - - ``G_BAUD_RATE_BPS``
      - positive
      - 0d115\_200
      - Baud rate in bps

Inputs and Outputs
------------------

.. list-table::
    :widths: 25 10 15 15 45
    :header-rows: 1

    - - Port Name
      - Type
      - Direction
      - Default Value
      - Description
    - - ``CLK``
      - std_logic
      - in
      - \-
      - Input clock
    - - ``RST_N``
      - std_logic
      - in
      - \-
      - Input asynchronous reset, active low
    - - ``I_UART_RX``
      - std_logic
      - in
      - \-
      - Asynchronous input UART RX line
    - - ``O_UART_TX``
      - std_logic
      - out
      - 0x1
      - Output UART TX line
    - - ``O_READ_ADDR``
      - vector
      - out
      - 0x00
      - Output read address
    - - ``O_READ_ADDR_VALID``
      - std_logic
      - out
      - 0x0
      - Output read address valid flag
    - - ``I_READ_DATA``
      - vector
      - in
      - \-
      - Input read data
    - - ``I_READ_DATA_ADDR_VALID``
      - std_logic
      - in
      - \-
      - Input read data valid
    - - ``O_WRITE_ADDR``
      - vector
      - out
      - 0x00
      - Output write address
    - - ``O_WRITE_DATA``
      - vector
      - out
      - 0x0000
      - Output write data
    - - ``O_WRITE_VALID``
      - std_logic
      - out
      - 0x0
      - Output write valid flag

Architecture
------------

.. image:: ../_static/svg/UART-UART.svg

Protocol
~~~~~~~~

The implemented UART protocol is an ASCII-based protocol to access the internal
registers of the FPGA. All commands and responses are ASCII text and every message is
terminated by a mandatory carriage-return (CR, ``\r``). A line-feed (LF, ``\n``) may
follow CR but is optional and ignored by the device.

The following fields are defined:

- ``AA``: 8-bit address (two ASCII hex characters)
- ``DDDD``: 16-bit data (four ASCII hex characters)

.. image:: ../_static/svg/UART-UART_PROTOCOL.svg
    :align: center
    :alt: UART Protocol Diagram

|

Read Mode
+++++++++

The read mode allows reading a 16-bit value from a specified 8-bit register address. The
device responds with the current register value.

**Command Format**

::

    R + AA + \r[\n]

- ``R``: literal ASCII 'R' (read command)
- ``AA``: two ASCII hex characters representing an 8-bit address (``00`` .. ``FF``)
- ``\r``: mandatory CR terminator (ASCII 0x0D)
- ``\n``: optional LF (ASCII 0x0A), if present it is ignored by the device

**Response Format**

::

    DDDD + \r[\n]

- ``DDDD``: four ASCII hex characters representing the 16-bit register value, MSB first
  (``0000`` .. ``FFFF``)
- ``\r``: mandatory CR terminator
- ``\n``: optional LF (ASCII 0x0A)

**Examples**

.. code-block:: none

    # Read address 0x1A
    Sent                   : R1A\r\n
    Bytes transmitted (hex): 0x52 0x31 0x41 0x0D 0x0A
    Reply                  : 0F3C\r
    Bytes received    (hex): 0x30 0x46 0x33 0x43 0x0D

.. code-block:: none

    # Read address 0xFF
    Sent                   : RFF\r
    Bytes transmitted (hex): 0x52 0x46 0x46 0x0D
    Reply                  : DEAD\r
    Bytes received    (hex): 0x44 0x45 0x39 0x44 0x0D

Write Mode
++++++++++

The write mode allows writing a 16-bit value to a specified 8-bit register address. The
device does not send any acknowledgment response after a successful write operation.

**Command Format**

::

    W + AA + DDDD + \r[\n]

- ``W``: literal ASCII 'W' (write command)
- ``AA``: two ASCII hex characters representing an 8-bit address (``00`` .. ``FF``)
- ``DDDD``: four ASCII hex characters representing the 16-bit data value to write, MSB
  first (``0000`` .. ``FFFF``)
- ``\r``: mandatory CR terminator (ASCII 0x0D)
- ``\n``: optional LF (ASCII 0x0A), if present it is ignored by the device

**Response Format**

No response is expected or generated by the device for write commands.

.. important::

    To verify that data was correctly written to the given address, perform a read-back
    operation using the read command on the same register address.

**Examples**

.. code-block:: none

    # Write value 0x1234 to address 0x1A
    Sent                   : W1A1234\r\n
    Bytes transmitted (hex): 0x57 0x31 0x41 0x31 0x32 0x33 0x34 0x0D 0x0A
    Reply                  : (no reply expected)

.. code-block:: none

    # Write value 0x0001 to address 0x01
    Sent                   : W010001\r
    Bytes transmitted (hex): 0x57 0x30 0x31 0x30 0x30 0x30 0x31 0x0D
    Reply                  : (no reply expected)

FSM
~~~

The UART FSM handling the above protocol is defined as:

.. image:: ../_static/svg/UART-UART_FSM.svg
